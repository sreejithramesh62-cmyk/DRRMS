<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DRRMS Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --primary:#d4af37;--primary-light:#f4e5a8;--primary-dark:#b8972f;
  --bg-dark:#0a0e1a;--bg-card:#12172a;--bg-hover:#1a2138;
  --text:#e8f0ff;--text-muted:#8b96a8;--border:#1e2840;
  --success:#10b981;--error:#ef4444;--warning:#f59e0b;--info:#3b82f6;
  --shadow:0 20px 60px rgba(0,0,0,.5);--glow:0 0 20px rgba(212,175,55,.3);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Inter',system-ui,sans-serif;background:#0a0e1a;color:var(--text);
  background-image:
    radial-gradient(circle at 20% 50%, rgba(212,175,55,.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(59,130,246,.03) 0%, transparent 50%);
  min-height:100vh;overflow-x:hidden;
}

.sidebar{
  position:fixed;left:0;top:0;width:280px;height:100vh;
  background:linear-gradient(180deg,var(--bg-card),#0d1320);
  border-right:1px solid var(--border);padding:24px;overflow-y:auto;
  box-shadow:4px 0 30px rgba(0,0,0,.4);z-index:100;
}
.logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--border)}
.logo-icon{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));display:grid;place-items:center;font-size:24px;font-weight:900;box-shadow:var(--glow)}
.logo h1{font-size:22px;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,var(--primary-light),var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav{list-style:none}
.nav-item{margin-bottom:8px}
.nav-link{
  display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;
  color:var(--text-muted);text-decoration:none;transition:.2s;font-weight:500;font-size:14px;cursor:pointer;
}
.nav-link:hover,.nav-link.active{background:var(--bg-hover);color:var(--primary)}
.nav-link.active{box-shadow:inset 0 0 0 1px var(--primary)}

.main{margin-left:280px;padding:24px;min-height:100vh}
.topbar{
  display:flex;justify-content:space-between;align-items:center;
  background:var(--bg-card);border-radius:16px;padding:16px 24px;margin-bottom:24px;
  border:1px solid var(--border);box-shadow:var(--shadow)
}
.search{display:flex;align-items:center;gap:12px;background:var(--bg-dark);padding:10px 16px;border-radius:10px;flex:1;max-width:400px}
.search input{background:none;border:none;color:var(--text);outline:none;width:100%;font-size:14px}
.user-menu{display:flex;align-items:center;gap:16px}
.user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--info));display:grid;place-items:center;font-weight:700;font-size:16px}
.logout-btn{
  padding:10px 18px;border-radius:10px;background:rgba(239,68,68,.1);border:1px solid #ef4444;
  color:#ff9b9b;cursor:pointer;font-weight:600;transition:.25s;font-size:13px;
}
.logout-btn:hover{background:#ef4444;color:#fff;transform:translateY(-2px)}

.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px}
.kpi-card{
  background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:24px;
  position:relative;overflow:hidden;transition:.3s;box-shadow:var(--shadow);
  animation:fadeUp .5s ease backwards;
}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.kpi-card:nth-child(1){animation-delay:.05s}
.kpi-card:nth-child(2){animation-delay:.1s}
.kpi-card:nth-child(3){animation-delay:.15s}
.kpi-card:nth-child(4){animation-delay:.2s}
.kpi-card::before{
  content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;
  background:radial-gradient(circle,rgba(212,175,55,.08),transparent 70%);
  opacity:0;transition:.3s;
}
.kpi-card:hover{transform:translateY(-4px);box-shadow:0 30px 80px rgba(0,0,0,.6)}
.kpi-card:hover::before{opacity:1}
.kpi-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.kpi-label{font-size:13px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
.kpi-icon{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;font-size:24px;background:rgba(212,175,55,.1)}
.kpi-value{font-size:36px;font-weight:800;color:var(--primary);margin-bottom:8px;text-shadow:0 0 20px rgba(212,175,55,.3)}
.kpi-trend{font-size:13px;color:var(--success);font-weight:500}

.grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px}
.panel{
  background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:20px;
  box-shadow:var(--shadow);animation:fadeUp .5s ease .25s backwards;
}
.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px}
.panel-title{font-size:18px;font-weight:700;color:var(--text)}
.btn{
  padding:10px 16px;border-radius:10px;border:1px solid var(--border);
  background:var(--bg-hover);color:var(--text);cursor:pointer;transition:.25s;
  font-weight:600;font-size:13px;
}
.btn:hover{background:var(--primary);color:#000;transform:translateY(-2px);box-shadow:0 8px 20px rgba(212,175,55,.3)}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#000}
.btn.danger{background:rgba(239,68,68,.1);border-color:#ef4444;color:#ff9b9b}
.btn.danger:hover{background:#ef4444;color:#fff}
.btn.success{background:var(--success);border-color:var(--success);color:#fff}

.chart-wrap{position:relative;height:300px;margin-top:16px}

table{width:100%;border-collapse:collapse}
th{text-align:left;padding:12px;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
td{padding:14px 12px;border-bottom:1px solid var(--border);font-size:14px}
tr{transition:.2s}
tr:hover{background:var(--bg-hover)}
.badge{
  padding:6px 12px;border-radius:999px;font-size:11px;font-weight:600;
  display:inline-block;text-transform:uppercase;letter-spacing:.5px;
}
.badge.success{background:rgba(16,185,129,.15);color:var(--success);border:1px solid var(--success)}
.badge.error{background:rgba(239,68,68,.15);color:var(--error);border:1px solid var(--error)}
.badge.warning{background:rgba(245,158,11,.15);color:var(--warning);border:1px solid var(--warning)}
.badge.info{background:rgba(59,130,246,.15);color:var(--info);border:1px solid var(--info)}

.notif-list{list-style:none;max-height:400px;overflow-y:auto}
.notif-item{
  display:flex;justify-content:space-between;align-items:flex-start;gap:12px;
  padding:14px;background:var(--bg-dark);border-radius:10px;margin-bottom:10px;
  border:1px solid var(--border);transition:.2s;
}
.notif-item:hover{background:var(--bg-hover)}
.notif-content{flex:1}
.notif-title{font-weight:600;color:var(--primary-light);margin-bottom:4px;font-size:14px}
.notif-msg{font-size:13px;color:var(--text-muted);line-height:1.5}
.notif-time{font-size:11px;color:var(--text-muted);margin-top:6px}
.icon-btn{
  padding:6px 10px;border-radius:6px;background:rgba(239,68,68,.1);
  border:1px solid #ef4444;color:#ff9b9b;cursor:pointer;transition:.2s;font-size:12px;
}
.icon-btn:hover{background:#ef4444;color:#fff}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
.modal.show{display:flex}
.modal-content{
  background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:32px;
  width:90%;max-width:600px;box-shadow:0 40px 100px rgba(0,0,0,.8);
  animation:zoomIn .3s ease;
}
@keyframes zoomIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.modal h3{margin-bottom:20px;color:var(--primary);font-size:24px;font-weight:700}
.modal input,.modal textarea,.modal select{
  width:100%;padding:14px;border-radius:10px;border:1px solid var(--border);
  background:var(--bg-dark);color:var(--text);margin:12px 0;font-family:inherit;font-size:14px;
}
.modal-actions{display:flex;gap:12px;margin-top:20px}

.admin-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:16px}
.admin-card{
  background:var(--bg-dark);border:1px solid var(--border);border-radius:12px;padding:16px;
  text-align:center;transition:.2s;
}
.admin-card:hover{background:var(--bg-hover);transform:translateY(-4px)}
.admin-avatar{
  width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--info));
  display:grid;place-items:center;font-weight:700;font-size:24px;margin:0 auto 12px;
}
.admin-name{font-weight:600;color:var(--text);margin-bottom:4px}
.admin-role{font-size:12px;color:var(--text-muted)}

.tab-content{display:none}
.tab-content.active{display:block}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="logo">
  <img src="logo.jpg" alt="DRRMS Logo" style="width:48px;height:48px;border-radius:12px;"/>
  <h1>DRRMS</h1>
</div>



  <ul class="nav">
    <li class="nav-item"><a class="nav-link active" onclick="showTab('dashboard')">üìä Dashboard</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('disasters')">‚ö†Ô∏è Disasters</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('volunteers')">üë• Volunteers</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('resources')">üì¶ Resources</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('requests')">üìã Requests</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('admins')">üë§ Admins</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('users')">üë§ User Logins</a></li>


  </ul>
</aside>

<main class="main">
  <div class="topbar">
    <div class="search">
      <span>üîç</span>
      <input type="text" placeholder="Search anything..."/>
    </div>
    <div class="user-menu">
      <span id="userName" style="font-weight:600;color:var(--text-muted)">Admin</span>
      <div class="user-avatar">A</div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Total Disasters</div>
        <div class="kpi-icon">‚ö†Ô∏è</div>
      </div>
      <div class="kpi-value" id="kpiDis">0</div>
      <div class="kpi-trend">‚Üó Active emergencies</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Volunteers</div>
        <div class="kpi-icon">üë•</div>
      </div>
      <div class="kpi-value" id="kpiVol">0</div>
      <div class="kpi-trend">‚úì Available on ground</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Resources</div>
        <div class="kpi-icon">üì¶</div>
      </div>
      <div class="kpi-value" id="kpiRes">0</div>
      <div class="kpi-trend">‚Üó Total stock units</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Notifications</div>
        <div class="kpi-icon">üîî</div>
      </div>
      <div class="kpi-value" id="kpiNote">0</div>
      <div class="kpi-trend">üì¨ New alerts</div>
    </div>
  </div>

  <div id="tab-dashboard" class="tab-content active">
    <div class="grid">
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">Disaster Trend (Last 7 Days)</h2>
        </div>
        <div class="chart-wrap"><canvas id="chartDisasters"></canvas></div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">Recent Notifications</h2>
          <button class="btn success" onclick="openNotificationModal()">+ Create</button>
        </div>
        <ul id="notifList" class="notif-list"></ul>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">Active Disasters</h2>
        <button class="btn primary" onclick="openDisasterModal()">+ Add New</button>
      </div>
      <table id="tblDis">
        <thead><tr><th>Name</th><th>Type</th><th>Location</th><th>Severity</th><th>Date</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-disasters" class="tab-content">
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">All Disasters</h2>
        <button class="btn primary" onclick="openDisasterModal()">+ Add Disaster</button>
      </div>
      <table id="tblDisastersFull">
        <thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Location</th><th>Severity</th><th>Date</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-volunteers" class="tab-content">
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">All Volunteers</h2>
        <button class="btn" onclick="loadVolunteersFull()">Refresh</button>
      </div>
      <table id="tblVolFull">
        <thead><tr><th>ID</th><th>Name</th><th>Contact</th><th>Status</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-resources" class="tab-content">
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">All Resources</h2>
        <button class="btn primary" onclick="openResourceModal()">+ Add Resource</button>
      </div>
      <table id="tblResFull">
        <thead><tr><th>ID</th><th>Name</th><th>Quantity</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-requests" class="tab-content">
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">Volunteer Requests</h2>
        <button class="btn" onclick="loadReqs()">Reload</button>
      </div>
      <table id="tblReq">
        <thead><tr><th>ID</th><th>Event</th><th>Message</th><th>Status</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-admins" class="tab-content">
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">Admin Users</h2>
      </div>
      <div id="adminGrid" class="admin-grid"></div>
    </div>
  </div>
  <div id="tab-users" class="tab-content">
  <div class="panel">
    <div class="panel-header">
      <h2 class="panel-title">All User Logins</h2>
      <button class="btn" onclick="loadUsers()">Refresh</button>
    </div>
    <table id="tblUsers">
      <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Registered</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>



</main>

<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Add Comment</h3>
    <textarea id="modalComment" rows="4" placeholder="Optional comment..."></textarea>
    <div class="modal-actions">
      <button class="btn primary" id="modalConfirm">Confirm</button>
      <button class="btn danger" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="disasterModal" class="modal">
  <div class="modal-content">
    <h3>Add New Disaster</h3>
    <input id="disName" placeholder="Event Name" required/>
    <input id="disType" placeholder="Event Type (e.g., Earthquake)"/>
    <input id="disLoc" placeholder="Location"/>
    <input id="disDate" type="date"/>
    <select id="disSev">
      <option value="">Severity</option>
      <option value="Low">Low</option>
      <option value="Medium">Medium</option>
      <option value="HIGH">HIGH</option>
      <option value="Severe">Severe</option>
    </select>
    <div class="modal-actions">
      <button class="btn primary" onclick="saveDisaster()">Save</button>
      <button class="btn danger" onclick="closeDisasterModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="resourceModal" class="modal">
  <div class="modal-content">
    <h3>Add New Resource</h3>
    <input id="resName" placeholder="Resource Name (e.g., Water Bottles)" required/>
    <input id="resQty" type="number" placeholder="Quantity" min="1"/>
    <div class="modal-actions">
      <button class="btn primary" onclick="saveResource()">Save</button>
      <button class="btn danger" onclick="closeResourceModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="notificationModal" class="modal">
  <div class="modal-content">
    <h3>Create Important Notification</h3>
    <input id="notifTitle" placeholder="Notification Title" required/>
    <textarea id="notifMessage" rows="4" placeholder="Notification message..." required></textarea>
    <div class="modal-actions">
      <button class="btn success" onclick="saveNotification()">Create Notification</button>
      <button class="btn danger" onclick="closeNotificationModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
const API = '/drrms/api/index.php';

// NEW: Store admin full name for tracking
const adminFullName = localStorage.getItem('userFullName') || localStorage.getItem('userName') || 'Admin';
const adminShortName = localStorage.getItem('userName') || 'Admin';
document.getElementById('userName').textContent = adminShortName;

let currentAction = null;
let currentId = null;
let disasterChart = null;

async function jget(path){ const r = await fetch(API + path); if (!r.ok) throw new Error(path); return r.json(); }
async function jpost(path, body){ const r = await fetch(API + path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); if (!r.ok) throw new Error(path); return r.json(); }

function logout(){ localStorage.clear(); location.href='login.html'; }

function showTab(tab){
  document.querySelectorAll('.tab-content').forEach(t => t.style.display='none');
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  const el = document.getElementById('tab-' + tab);
  if(el) el.style.display='block';
  event.target.classList.add('active');
  
  if(tab === 'disasters') loadDisastersFull();
  if(tab === 'volunteers') loadVolunteersFull();
  if(tab === 'resources') loadResourcesFull();
  if(tab === 'requests') loadReqs();
  if(tab === 'admins') loadAdmins();
  if (tab === 'users') loadUsers();  // ADD THIS LINE
}

async function loadDisasters(){
  const data = await jget('/user/events');
  document.getElementById('kpiDis').textContent = data.length;
  const tb = document.querySelector('#tblDis tbody');
  tb.innerHTML = '';
  data.forEach(d => {
    const sevClass = (d.severity||'').toLowerCase().includes('high') || (d.severity||'').toLowerCase().includes('severe') ? 'error' : (d.severity||'').toLowerCase().includes('medium') ? 'warning' : 'success';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.event_name}</td><td>${d.event_type||'‚Äî'}</td><td>${d.location||'‚Äî'}</td><td><span class="badge ${sevClass}">${d.severity||'‚Äî'}</span></td><td>${d.event_date||'‚Äî'}</td>`;
    tb.appendChild(tr);
  });
  renderChart(data);
}

async function loadDisastersFull(){
  const data = await jget('/user/events');
  const tb = document.querySelector('#tblDisastersFull tbody');
  if(!tb) return;
  tb.innerHTML = '';
  data.forEach(d => {
    const sevClass = (d.severity||'').toLowerCase().includes('high') || (d.severity||'').toLowerCase().includes('severe') ? 'error' : (d.severity||'').toLowerCase().includes('medium') ? 'warning' : 'success';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.event_id}</td><td>${d.event_name}</td><td>${d.event_type||'‚Äî'}</td><td>${d.location||'‚Äî'}</td><td><span class="badge ${sevClass}">${d.severity||'‚Äî'}</span></td><td>${d.event_date||'‚Äî'}</td>`;
    tb.appendChild(tr);
  });
}

function renderChart(data){
  const ctx = document.getElementById('chartDisasters');
  if(!ctx) return;
  const labels = data.slice(0,7).map(d => d.event_name.substring(0,10));
  const sevMap = {Low:1, Medium:2, HIGH:3, Severe:4};
  const values = data.slice(0,7).map(d => sevMap[d.severity] || 2);
  
  if(disasterChart) disasterChart.destroy();
  disasterChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Severity Trend',
        data: values,
        borderColor: '#d4af37',
        backgroundColor: 'rgba(212,175,55,.1)',
        tension: .4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#8b96a8' }, grid: { color: '#1e2840' } },
        x: { ticks: { color: '#8b96a8' }, grid: { color: '#1e2840' } }
      }
    }
  });
}

// UPDATED: Show admin name in notifications
async function loadNotifications(){
  const notes = await jget('/admin/notifications');
  document.getElementById('kpiNote').textContent = notes.length;
  const ul = document.getElementById('notifList');
  ul.innerHTML = '';
  notes.slice(0,5).forEach(n => {
    const li = document.createElement('li');
    li.className = 'notif-item';
    
    // NEW: Show admin name badge if available
    const adminBadge = n.admin_name 
      ? `<br><span class="badge info" style="font-size:10px;margin-top:4px">by ${n.admin_name}</span>` 
      : '';
    
    li.innerHTML = `
      <div class="notif-content">
        <div class="notif-title">${n.title}</div>
        <div class="notif-msg">${n.message}${adminBadge}</div>
        <div class="notif-time">${new Date(n.created_at).toLocaleString()}</div>
      </div>
      <button class="icon-btn" onclick="deleteNotif(${n.note_id})">‚úï</button>
    `;
    ul.appendChild(li);
  });
}

async function deleteNotif(id){
  if(!confirm('Clear this notification?')) return;
  await jpost('/admin/delete_notification', {note_id: id});
  loadNotifications();
}

// UPDATED: Show admin name in requests table
async function loadReqs(){
  const data = await jget('/admin/requests');
  const tb = document.querySelector('#tblReq tbody');
  tb.innerHTML = '';
  data.forEach(r => {
    const badgeClass = r.status === 'Approved' ? 'success' : r.status === 'Rejected' ? 'error' : 'warning';
    const tr = document.createElement('tr');
    
    // NEW: Show admin name if request was processed
    const adminInfo = r.admin_name 
      ? `<br><small style="color:var(--text-muted)">by ${r.admin_name}</small>` 
      : '';
    
    const btns = r.status === 'Pending' 
      ? `<button class="btn" onclick="openModal('approve',${r.request_id})">Approve</button>
         <button class="btn danger" onclick="openModal('reject',${r.request_id})">Reject</button>`
      : `<span class="badge ${badgeClass}">${r.status}${adminInfo}</span>`;
    
    tr.innerHTML = `<td>${r.request_id}</td><td>${r.event_name||'‚Äî'}</td><td>${r.request_message||'‚Äî'}</td>
                    <td><span class="badge ${badgeClass}">${r.status}</span></td><td>${btns}</td>`;
    tb.appendChild(tr);
  });
}

async function loadVolunteers(){
  const data = await jget('/user/volunteers');
  document.getElementById('kpiVol').textContent = data.length;
}

async function loadVolunteersFull(){
  const data = await jget('/user/volunteers');
  const tb = document.querySelector('#tblVolFull tbody');
  if(!tb) return;
  tb.innerHTML = '';
  data.forEach(v => {
    const statusClass = v.status === 'Active' ? 'success' : 'info';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${v.volunteer_id}</td><td>${v.volunteer_name}</td><td>${v.contact||'‚Äî'}</td>
      <td><span class="badge ${statusClass}">${v.status||'‚Äî'}</span></td>
      <td><button class="btn danger" onclick="deleteVolunteer(${v.volunteer_id},'${v.volunteer_name}')">Remove</button></td>`;
    tb.appendChild(tr);
  });
}

async function loadResources(){
  const data = await jget('/user/resources');
  document.getElementById('kpiRes').textContent = data.reduce((sum, r) => sum + (r.total || 0), 0);
}

async function loadResourcesFull(){
  const data = await jget('/user/resources');
  const tb = document.querySelector('#tblResFull tbody');
  if(!tb) return;
  tb.innerHTML = '';
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.resource_id}</td><td>${r.resource_name}</td><td><strong>${r.total}</strong></td>
      <td><button class="btn" onclick="editResource(${r.resource_id},'${r.resource_name}',${r.total})">Edit</button></td>`;
    tb.appendChild(tr);
  });
}

async function loadAdmins(){
  const data = await jget('/admin/get_admins');
  const grid = document.getElementById('adminGrid');
  grid.innerHTML = '';
  data.forEach(a => {
    const card = document.createElement('div');
    card.className = 'admin-card';
    card.innerHTML = `
      <div class="admin-avatar">${a.username.charAt(0).toUpperCase()}</div>
      <div class="admin-name">${a.username}</div>
      <div class="admin-role">${a.full_name || 'Administrator'}</div>
    `;
    grid.appendChild(card);
  });
}
async function loadUsers(){
  const data = await jget('/admin/get_users');
  const tb = document.querySelector('#tblUsers tbody');
  if(!tb) return;
  tb.innerHTML = '';
  data.forEach(u => {
    const tr = document.createElement('tr');
    const regDate = new Date(u.created_at).toLocaleDateString();
    tr.innerHTML = `
      <td>${u.user_id}</td>
      <td><strong>${u.name}</strong></td>
      <td>${u.email}</td>
      <td>${u.phone || '‚Äî'}</td>
      <td><span class="badge info">${regDate}</span></td>
    `;
    tb.appendChild(tr);
  });
}



function openModal(action, id){ currentAction = action; currentId = id; document.getElementById('modalTitle').textContent = action === 'approve' ? 'Approve Request' : 'Reject Request'; document.getElementById('modal').classList.add('show'); }
function closeModal(){ document.getElementById('modal').classList.remove('show'); document.getElementById('modalComment').value = ''; }

// UPDATED: Send admin full name when approving/rejecting
document.getElementById('modalConfirm').addEventListener('click', async ()=>{
  const comment = document.getElementById('modalComment').value.trim();
  const adminFullName = localStorage.getItem('userFullName') || localStorage.getItem('userName') || 'Admin';
  const endpoint = currentAction === 'approve' ? '/admin/approve_request' : '/admin/reject_request';
  
  const data = await jpost(endpoint, { 
    request_id: currentId, 
    comment: comment,
    admin_name: adminFullName  // NEW: Send full admin name with ID
  });
  
  alert(data.message || 'Action completed');
  closeModal();
  loadReqs();
  loadNotifications();
});

function openDisasterModal(){ document.getElementById('disasterModal').classList.add('show'); }
function closeDisasterModal(){ document.getElementById('disasterModal').classList.remove('show'); }

async function saveDisaster(){
  const name = document.getElementById('disName').value.trim();
  const type = document.getElementById('disType').value.trim();
  const loc = document.getElementById('disLoc').value.trim();
  const date = document.getElementById('disDate').value;
  const sev = document.getElementById('disSev').value;
  if(!name){ alert('Event name required'); return; }
  await jpost('/admin/add_disaster', { event_name:name, event_type:type, location:loc, event_date:date, severity:sev });
  alert('Disaster added!');
  closeDisasterModal();
  loadDisasters();
  loadDisastersFull();
}

function openResourceModal(){ document.getElementById('resourceModal').classList.add('show'); }
function closeResourceModal(){ document.getElementById('resourceModal').classList.remove('show'); document.getElementById('resName').value = ''; document.getElementById('resQty').value = ''; }

async function saveResource(){
  const name=document.getElementById('resName').value.trim();
  const qty=parseInt(document.getElementById('resQty').value)||0;
  if(!name||qty<=0){alert('Name and quantity required');return}
  
  try{
    const result=await jpost('/admin/add_resource',{resource_name:name,quantity:qty,center_id:1});
    console.log('Resource add success:',result);
    alert('‚úÖ Resource added successfully!');
    closeResourceModal();
    loadResourcesFull();
    loadResources();
  }catch(err){
    console.error('Resource add error:',err);
    alert('‚ùå Error adding resource:\n\n'+err.message+'\n\nCheck browser Console (F12) for details');
  }
}


async function editResource(id, name, qty){
  const newQty = prompt(`Update quantity for ${name}:`, qty);
  if(!newQty || newQty == qty) return;
  await jpost('/admin/update_resource', { resource_id:id, quantity:parseInt(newQty) });
  alert('Resource updated!');
  loadResourcesFull();
  loadResources();
}

async function deleteVolunteer(id, name){
  if(!confirm(`Remove volunteer "${name}"? This action cannot be undone.`)) return;
  try{
    await jpost('/admin/delete_volunteer', { volunteer_id: id });
    alert('‚úÖ Volunteer removed successfully!');
    loadVolunteersFull();
    loadVolunteers();
  }catch(e){
    alert('Error removing volunteer: ' + e.message);
  }
}

function openNotificationModal(){ document.getElementById('notificationModal').classList.add('show'); }
function closeNotificationModal(){ 
  document.getElementById('notificationModal').classList.remove('show');
  document.getElementById('notifTitle').value = '';
  document.getElementById('notifMessage').value = '';
}

// UPDATED: Send admin full name when creating notification
async function saveNotification(){
  const title = document.getElementById('notifTitle').value.trim();
  const message = document.getElementById('notifMessage').value.trim();
  const adminFullName = localStorage.getItem('userFullName') || localStorage.getItem('userName') || 'Admin';
  
  if(!title || !message){ alert('Title and message required'); return; }
  
  try{
    await jpost('/admin/add_notification', { 
      title, 
      message,
      admin_name: adminFullName  // NEW: Send full admin name with ID
    });
    alert('‚úÖ Notification created successfully!');
    closeNotificationModal();
    loadNotifications();
  }catch(e){
    alert('Error creating notification: ' + e.message);
  }
}
// Load Users Tab
// Load Users Function - ADD THIS


// View user details (optional)
function viewUserDetails(userId) {
  alert(`User details for ID: ${userId}\n\nThis can be expanded to show full user profile, activity logs, etc.`);
}


async function loadAll(){
  await Promise.all([loadDisasters(), loadNotifications(), loadReqs(), loadVolunteers(), loadResources()]);
}

loadAll();
</script>
</body>
</html>
